name: cibuild on cpu

on: [workflow_dispatch, push]

env:
  IMAGE: registry.cn-shanghai.aliyuncs.com/pai-dlc/hybridbackend:developer-tf1.15-py3.6-manylinux_2_24
  JOBNAME: hbci-${{ github.run_id }}
  PODNAME: hbci-${{ github.run_id }}-chief-0

jobs:
  cibuild:
    runs-on: ubuntu-latest
    environment: tf1.15-py3.6-manylinux_2_24
    steps:
    - name: Checkout Code
      uses: actions/checkout@v2
      with:
        submodules: 'true'
    - name: Setup Environment
      uses: aliyun/ack-set-context@v1
      with:
        access-key-id: "${{ secrets.ACCESS_KEY_ID }}"
        access-key-secret: "${{ secrets.ACCESS_KEY_SECRET }}"
        cluster-id: "${{ secrets.ACK_CLUSTER_ID }}"
    - name: Upload
      run: |-
        helm install ${JOBNAME} cibuild/ \
        --set image=${IMAGE} \
        --set gpus=0 && \
        cibuild/upload ${PODNAME} ../cibuild
    - name: Lint
      run: |-
        kubectl exec -it ${PODNAME} -- sh -c 'make lint'
    - name: Build
      run: |-
        kubectl exec -it ${PODNAME} -- sh -c 'make -j32 HYBRIDBACKEND_WHEEL_ALIAS=-cpu-nightly HYBRIDBACKEND_WHEEL_BUILD=rc${{ github.run_id }}'
    - name: Install
      run: |-
        kubectl exec -it ${PODNAME} -- sh -c 'mkdir -p /opt/hybridbackend/ && cp -rf tests /opt/hybridbackend/ && PYTHONPATH= pip install cibuild/dist/*.whl'
    - name: Test
      run: |-
        kubectl exec -it ${PODNAME} -- sh -c 'PYTHONPATH=/opt/hybridbackend TEST_ALLOWS=cpu make test'
    - name: Cleanup Environment
      if: always()
      run: |-
        helm uninstall ${JOBNAME}
