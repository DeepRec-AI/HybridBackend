name: Tests with TensorFlow 1.15 on CPU

on: workflow_dispatch

env:
  IMAGE: registry.cn-shanghai.aliyuncs.com/pai-dlc/hybridbackend:developer-tensorflow1.15-manylinux_2_24-py3.6
  JOBNAME: hbci-tf115-cpu-${{ github.run_id }}
  PODNAME: hbci-tf115-cpu-${{ github.run_id }}-chief-0
  ARROW_CACHE_URL_PREFIX: ${{ secrets.ARROW_CACHE_URL_PREFIX }}

jobs:
  build:
    runs-on: ubuntu-latest
    environment: TensorFlow 1.15
    steps:
    - name: Checkout Code
      uses: actions/checkout@v2
      with:
        submodules: 'true'
    - name: Configure Environment
      uses: aliyun/ack-set-context@v1
      with:
        access-key-id: "${{ secrets.ACCESS_KEY_ID }}"
        access-key-secret: "${{ secrets.ACCESS_KEY_SECRET }}"
        cluster-id: "${{ secrets.ACK_CLUSTER_ID }}"
    - name: Setup Environment
      run: |-
        helm install ${JOBNAME} cibuild/ --set image=${IMAGE} --set tag=tensorflow1.15-py3.6 && \
        cibuild/upload ${PODNAME} ../cibuild && \
        kubectl exec -it ${PODNAME} -- arrow/download.sh ${ARROW_CACHE_URL_PREFIX}
    - name: Nightly Build
      if: github.event_name != 'push' || ! startsWith(github.ref, 'refs/tags')
      run: |-
        kubectl exec -it ${PODNAME} -- sh -c 'make -j32 HYBRIDBACKEND_WHEEL_ALIAS=-cpu-nightly HYBRIDBACKEND_WHEEL_BUILD=rc${{ github.run_id }}' && \
        kubectl exec -it ${PODNAME} -- cibuild/repair_dist
    - name: Release Build
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
      run: |-
        kubectl exec -it ${PODNAME} -- sh -c 'make -j32 HYBRIDBACKEND_WHEEL_ALIAS=-cpu HYBRIDBACKEND_WHEEL_REQUIRES="tensorflow>=1.15,<2.0"' && \
        kubectl exec -it ${PODNAME} -- cibuild/repair_dist
    - name: Check 
      run: |-
        kubectl exec -it ${PODNAME} -- make lint cpu_test && \
        kubectl exec -it ${PODNAME} -- tar -cf dist.tar dist/ && \
        kubectl cp ${PODNAME}:dist.tar ./dist.tar && \
        tar -xf ./dist.tar
    - name: Publish
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        skip_existing: true
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
    - name: Cleanup Environment
      if: always()
      run: |-
        helm uninstall ${JOBNAME}
